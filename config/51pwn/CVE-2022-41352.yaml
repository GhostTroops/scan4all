id: CVE-2022-41352_51pwn

info:
  name: Zimbra Collaboration (ZCS) 8.8.15 and 9.0. upload arbitrary files through amavisd
  author: 51pwn
  severity: critical
  description: |
    An issue was discovered in Zimbra Collaboration (ZCS) 8.8.15 and 9.0. 
    An attacker can upload arbitrary files through amavisd via a cpio loophole 
    (extraction to /opt/zimbra/jetty/webapps/zimbra/public) that can lead to incorrect access to any o
    ther user accounts. Zimbra recommends pax over cpio. Also, pax is in the prerequisites of 
    Zimbra on Ubuntu; however, pax is no longer part of a default Red Hat installation after RHEL 6 (or CentOS 6). 
    Once pax is installed, amavisd automatically prefers it over cpio.
    test: 
    https://mail.zimbra.com
    http://mail.cre8.com.tw/zimbra/
    How Test: 
    1- 需要有邮件系统的账号
    2- 给自己发带攻击的附件的邮件
    3- 在邮件系统中在线打开附件
    docker run -d -p 25:25 -p 80:80 -p 465:465 -p 587:587 -p 110:110 -p 143:143 -p 993:993 -p 995:995 -p 443:443 -p 8080:8080 -p 8443:8443 -p 7071:7071 -p 9071:9071 -h zimbra-docker.zimbra.io --dns 127.0.0.1 --dns 8.8.8.8 -i -t -e PASSWORD=Zimbra2017 jorgedlcruz/zimbra
    docker run -d -p 25:25 -p 80:80 -p 465:465 -p 587:587 -p 110:110 -p 143:143 -p 993:993 -p 995:995 -p 443:443 -p 8080:8080 -p 8443:8443 -p 7071:7071 -p 9071:9071 -h zimbra-docker.zimbra.io --dns 127.0.0.1 --dns 8.8.8.8 -i -t -e PASSWORD=Zimbra2017 jorgedlcruz/zimbra
    需要等一些时间，docker初始化
    user: zimbra 无密码
    http://127.0.0.1
    admin http://127.0.0.1:7071
    
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2022-41352
    - https://forums.zimbra.org/viewtopic.php?t=71153&p=306532
    - https://wiki.zimbra.com/wiki/Security_Center
    - https://wiki.zimbra.com/wiki/Zimbra_Security_Advisories
  tags: cve2022,RCE,zcs

requests:
  - raw:
      - |
        POST /mgmt/tm/util/bash HTTP/1.1
       
      - |
        GET /public/x3.jsp
    matchers-condition: and
    matchers:
      - type: regex
        regex:
          - "(commandResult)"
          - "(uid=\\d+\\(.*)"
      - type: status
        status:
          - 200
        condition: and
    extractors:
      - type: regex
        part: body
        regex:
          - "(uid=\\d+\\([^\\n]{3,})"